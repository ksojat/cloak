(ns rosado.cloak-build
  (:import (java.io File))
  (:require [rosado.cloak :as cloak])
  (:use [rosado.cloak.ant :only [ant]])
  (:use rosado.cloak.main)
  (:use rosado.cloak.actions))

(defn path [& segments]
  (reduce (fn [base seg] (if base (File. base seg) (File. seg))) segments))

(def props
  {:dest (path "build" "cloak")
   :src  (path "cloak" "src")})

(task :anttest
  (ant :echo {:message "Hi"}))

(task :compile
  "Compile Cloak."
  (clojurec [(:src props)] (:dest props)))

(task :clean
      "Removes the 'classes' directory "
      (when (exists? "classes/rosado")
        (rm "classes/rosado")))

(task :jar-src
      "Creates a jar file with Cloak's sources"
      (sh "jar cf bin/rosado.cloak.jar rosado" :dofail))

(task :jar ["bin/rosado.cloak.jar"]
      "Creates a jar file with compiled Cloak class files.")

(file "bin/rosado.cloak.jar" ["classes/rosado"]
      (when-not (exists? "bin")
        (mkdir "bin"))
      (sh "jar cf bin/rosado.cloak.jar -C classes rosado" :dofail))

; TODO: Restore later, no global bindings
;(task :test
;      (binding [cloak/*CWD* (str (System/getProperty "user.dir") "/tests")]
;        (load-file "tests/basic.clj")))
