(ns rosado.cloak-build
  (:require [rosado.cloak :as cloak])
  (:use rosado.cloak.main)
  (:use rosado.cloak.actions))

;; assumptions:  clojure.jar
;; also, classes dir must already be in your classpath (for compilation)

;(import '(java.io File)
;        '(org.apache.tools.ant Project NoBannerLogger)
;        '(org.apache.tools.ant.types Path))

(import '(java.io File))

(defn path [& segments]
  (reduce (fn [base seg] (if base (File. base seg) (File. seg))) segments))

(def props
  {:dest (path "build" "cloak")
   :src  (path "cloak" "src")})

;(def +ant-logger+
;  (doto (NoBannerLogger.)
;    (.setMessageOutputLevel Project/MSG_INFO)
;    (.setOutputPrintStream System/out)
;    (.setErrorPrintStream System/err)))

;(def +ant-project+
;  (doto (Project.)
;    (.init)
;    (.setBaseDir (File. (System/getProperty "user.home")))
;    (.addTaskDefinition "clojurec" rosado.cloak.anttasks.ClojureCompile)
;    (.addBuildListener +ant-logger+)))

(task :compile
  "Compile Cloak."
  (clojurec [(:src props)] (:dest props)))

(task :clean
      "Removes the 'classes' directory "
      (when (exists? "classes/rosado")
        (rm "classes/rosado")))

(task :jar-src
      "Creates a jar file with Cloak's sources"
      (sh "jar cf bin/rosado.cloak.jar rosado" :dofail))

(task :jar ["bin/rosado.cloak.jar"]
      "Creates a jar file with compiled Cloak class files.")

(file "bin/rosado.cloak.jar" ["classes/rosado"]
      (when-not (exists? "bin")
        (mkdir "bin"))
      (sh "jar cf bin/rosado.cloak.jar -C classes rosado" :dofail))

(task :test
      (binding [cloak/*CWD* (str (System/getProperty "user.dir") "/tests")]
        (load-file "tests/basic.clj")))
